<div class="browse-pets-container p-4">
  <!-- Header Section -->
  <div class="header-section mb-6">
    <div class="text-center mb-4">
      <h1 class="text-4xl font-bold text-900 mb-2">Browse Available Pets</h1>
      <p class="text-xl text-600">
        Find your perfect companion from shelters near you
      </p>
    </div>

    <!-- Search and Filter Controls -->
    <div class="filters-section bg-white p-4 border-round-xl shadow-2">
      <div class="grid">
        <!-- Location Search -->
        <div class="col-12 lg:col-6 xl:col-4">
          <label
            for="location-input"
            class="block text-sm font-medium mb-2 text-900"
          >
            <i class="pi pi-map-marker mr-1"></i>Location
          </label>
          <input
            #locationInput
            id="location-input"
            type="text"
            pInputText
            placeholder="Enter your location..."
            [(ngModel)]="searchLocation"
            (input)="onLocationChange()"
            class="w-full"
            [class.p-invalid]="isLoadingLocation()"
            autocomplete="off"
          />
          <div class="mt-2">
            <p-button
              label="Use My Location"
              icon="pi pi-map-marker"
              size="small"
              [text]="true"
              (onClick)="getCurrentLocationAndSearch()"
              [loading]="isLoadingLocation()"
              pTooltip="Use your current location and search for pets"
            />
          </div>
        </div>

        <!-- Distance -->
        <div class="col-12 lg:col-6 xl:col-2">
          <label
            for="distance-range"
            class="block text-sm font-medium mb-2 text-900"
          >
            Max Distance: {{ maxDistance() }}km
          </label>
          <p-slider
            [min]="5"
            [max]="100"
            [step]="5"
            [(ngModel)]="maxDistance"
            (onSlideEnd)="onDistanceChange()"
          />
          <div class="flex justify-content-between text-xs text-600 mt-1">
            <span>5km</span>
            <span>100km</span>
          </div>
        </div>

        <!-- Species Filter -->
        <div class="col-12 lg:col-6 xl:col-3">
          <label
            for="species-select"
            class="block text-sm font-medium mb-2 text-900"
          >
            <i class="pi pi-star mr-1"></i>Pet Type
          </label>
          <p-select
            optionLabel="label"
            optionValue="value"
            placeholder="Select pet type"
            class="w-full"
            [options]="speciesOptions()"
            [loading]="isLoadingSpecies()"
            [(ngModel)]="selectedSpecies"
            (onChange)="onSpeciesChange()"
          />
          @if (isLoadingSpecies()) {
          <small class="text-primary">
            <i class="pi pi-spin pi-spinner mr-1"></i>Loading pet types...
          </small>
          }
        </div>

        <!-- Breed Filter -->
        <div class="col-12 lg:col-6 xl:col-3">
          <label
            for="breed-select"
            class="block text-sm font-medium mb-2 text-900"
          >
            <i class="pi pi-heart mr-1"></i>Breed
          </label>
          <p-autocomplete
            class="w-full"
            optionLabel="label"
            placeholder="Select or search breed"
            [suggestions]="filteredBreeds()"
            [dropdown]="true"
            [disabled]="!selectedSpecies() || isLoadingBreeds()"
            [showClear]="true"
            [(ngModel)]="selectedBreedObject"
            (completeMethod)="searchBreeds($event)"
            (onSelect)="onBreedChange()"
            (onClear)="onBreedChange()"
          />
          @if (isLoadingBreeds()) {
          <small class="text-primary">
            <i class="pi pi-spin pi-spinner mr-1"></i>Loading breeds...
          </small>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Results Summary -->
  <div class="results-summary mb-4">
    <div class="flex justify-content-between align-items-center">
      <h2 class="text-xl font-semibold text-900 m-0">
        {{ filteredPets().length }} pets found @if (searchLocation()) {
        <span class="text-600 font-normal">near {{ searchLocation() }}</span>
        }
      </h2>

      @if (filteredPets().length > 0) {
      <span class="text-sm text-600">
        Showing {{ currentPage() * pageSize() + 1 }}-{{ Math.min((currentPage()
        + 1) * pageSize(), filteredPets().length) }} of {{ filteredPets().length
        }} results
      </span>
      }
    </div>
  </div>

  <!-- Top Pagination -->
  @if(!isLoading() && filteredPets().length > 0){
  <div class="flex justify-content-center mb-4">
    <p-paginator
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} pets"
      [rows]="pageSize()"
      [totalRecords]="totalRecords()"
      [first]="currentPage() * pageSize()"
      [showCurrentPageReport]="true"
      [rowsPerPageOptions]="[12, 24, 36]"
      (onPageChange)="onPageChange($event)"
    />
  </div>
  }

  <!-- Loading State -->
  @if (isLoading()) {
  <div class="grid">
    @for (i of [1, 2, 3, 4, 5, 6]; track i) {
    <div class="col-12 md:col-6 lg:col-4 xl:col-3 mb-4">
      <p-card>
        <div class="flex flex-column gap-3">
          <p-skeleton height="200px" />
          <p-skeleton height="1.5rem" width="80%" />
          <p-skeleton height="1rem" width="60%" />
          <div class="flex gap-2">
            <p-skeleton height="2rem" width="4rem" />
            <p-skeleton height="2rem" width="4rem" />
          </div>
        </div>
      </p-card>
    </div>
    }
  </div>
  }

  <!-- Pet Grid -->
  @if (!isLoading() && filteredPets().length > 0) {
  <div class="grid">
    @for (pet of getPaginatedPets(); track pet.petPostgreSqlId) {
    <div class="col-12 md:col-6 lg:col-4 xl:col-3 mb-4">
      <p-card
        class="pet-card h-full cursor-pointer hover:shadow-3 transition-all transition-duration-200"
        (click)="onPetClick(pet)"
      >
        <div class="pet-card-content">
          <!-- Pet Image -->
          <div class="pet-image-container mb-3 relative">
            <img
              [src]="pet.imageUrl"
              [alt]="pet.name"
              class="w-full h-12rem object-cover border-round"
              loading="lazy"
            />
            <div class="distance-badge">
              <p-tag
                value="{{ pet.distance }}km away"
                severity="info"
                [rounded]="true"
              />
            </div>
          </div>

          <!-- Pet Info -->
          <div class="pet-info">
            <div class="flex justify-content-between align-items-start mb-2">
              <h3 class="text-xl font-bold text-900 m-0">{{ pet.name }}</h3>
              <span class="text-lg font-semibold text-primary"
                >${{ pet.adoptionFee }}</span
              >
            </div>

            <div class="pet-details mb-3">
              <p class="text-600 text-sm m-0 mb-1">
                <i class="pi pi-info-circle mr-1"></i>
                {{ pet.species }} • {{ pet.breed }} • {{ pet.age }} years old
              </p>
              <p class="text-600 text-sm m-0 mb-2">
                <i class="pi pi-map-marker mr-1"></i>
                {{ pet.location }} • {{ pet.shelter }}
              </p>
              <div
                class="text-700 text-sm line-height-3 mb-3"
                [innerHTML]="pet.description"
              ></div>
            </div>

            <!-- Pet Attributes -->
            <div class="pet-attributes mb-3">
              <div class="flex gap-1 flex-wrap">
                @if (pet.isSpayedNeutered) {
                <p-tag
                  value="Spayed/Neutered"
                  severity="success"
                  [rounded]="true"
                />
                } @if (pet.isGoodWithKids) {
                <p-tag
                  value="Good with kids"
                  severity="info"
                  [rounded]="true"
                />
                } @if (pet.isGoodWithPets) {
                <p-tag
                  value="Good with pets"
                  severity="warning"
                  [rounded]="true"
                />
                }
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-2">
              <p-button
                label="Contact Shelter"
                icon="pi pi-phone"
                size="small"
                class="flex-1"
                (onClick)="onContactShelter(pet, $event)"
              />
              <p-button
                icon="pi pi-external-link"
                size="small"
                severity="secondary"
                [outlined]="true"
                pTooltip="View details"
                (click)="onPetClick(pet, $event)"
              />
            </div>
          </div>
        </div>
      </p-card>
    </div>
    }
  </div>

  <!-- Pagination -->
  <div class="flex justify-content-center mt-6">
    <p-paginator
      [rows]="pageSize()"
      [totalRecords]="totalRecords()"
      [first]="currentPage() * pageSize()"
      (onPageChange)="onPageChange($event)"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} pets"
      [rowsPerPageOptions]="[12, 24, 36]"
    />
  </div>
  }

  <!-- No Results -->
  @if (!isLoading() && filteredPets().length === 0) {
  <div class="no-results text-center py-8">
    @if (!currentLocationCoords()) {
    <!-- No location provided -->
    <div class="mb-4">
      <i class="pi pi-map-marker text-6xl text-400"></i>
    </div>
    <h3 class="text-2xl font-semibold text-900 mb-3">
      Enter your location to find pets
    </h3>
    <p class="text-600 mb-4 max-w-md mx-auto">
      Please enter your location or use "Use My Location" to discover adoptable
      pets near you.
    </p>
    } @else {
    <!-- Location provided but no results -->
    <div class="mb-4">
      <i class="pi pi-search text-6xl text-400"></i>
    </div>
    <h3 class="text-2xl font-semibold text-900 mb-3">No pets found</h3>
    <p class="text-600 mb-4 max-w-md mx-auto">
      We couldn't find any pets matching your criteria in this area. Try
      adjusting your filters or searching in a wider radius.
    </p>
    <p-button
      label="Clear All Filters"
      icon="pi pi-times"
      severity="secondary"
      [outlined]="true"
      (onClick)="clearFilters()"
    />
    }
  </div>
  }
</div>

<!-- Contact Shelter Dialog -->
<app-contact-shelter-dialog
  [visible]="showContactDialog"
  [pet]="selectedPetForContact"
  (visibleChange)="showContactDialog.set($event)"
  (viewPetDetails)="onPetClick($event)"
/>
