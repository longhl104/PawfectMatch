<div class="dashboard-container">
  <div class="grid">
    <!-- Shelter Information Section -->
    <div class="col-12">
      <p-card header="Shelter Information" styleClass="h-full">
        <div class="grid" *ngIf="shelterInfo">
          <div class="col-12 md:col-6">
            <div class="field">
              <h2 class="text-lg font-semibold m-0">
                {{ shelterInfo.shelterName }}
              </h2>
              <p class="text-600 m-0">{{ shelterInfo.shelterAddress }}</p>
            </div>
          </div>
          <div class="col-12 md:col-3">
            <div class="field">
              <h3 class="text-sm text-600 m-0 mb-1">Contact</h3>
              <p class="m-0">{{ shelterInfo.shelterContactNumber }}</p>
              <p class="m-0">
                {{ (authService.currentUser$ | async)?.email }}
              </p>
            </div>
          </div>
          <div class="col-12 md:col-3">
            <div class="field">
              <h3 class="text-sm text-600 m-0 mb-1">Adopted Pets</h3>
              <p class="m-0 text-lg" *ngIf="petStatistics">
                {{ getAdoptedPetsCount() }} /
                {{ petStatistics.totalPets }}
                <span class="text-sm text-600">pets adopted</span>
              </p>
              <p
                class="m-0 text-lg text-600"
                *ngIf="!petStatistics && !isLoading"
              >
                Statistics unavailable
              </p>
              <div
                class="w-full bg-gray-200 border-round h-1rem mt-2"
                *ngIf="petStatistics"
              >
                <div
                  class="bg-primary border-round h-full transition-all transition-duration-300"
                  [style.width]="
                    (petStatistics.totalPets || 0) > 0
                      ? (getAdoptedPetsCount() /
                          (petStatistics.totalPets || 1)) *
                          100 +
                        '%'
                      : '0%'
                  "
                ></div>
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="isLoading" class="flex justify-content-center">
          <i class="pi pi-spinner pi-spin text-2xl"></i>
        </div>
      </p-card>
    </div>

    <!-- Action Buttons -->
    <div class="col-12">
      <div class="flex gap-3 mb-3">
        <p-button
          label="Add Pet"
          icon="pi pi-plus"
          severity="success"
          (onClick)="onAddPet()"
          [disabled]="isLoading"
        >
        </p-button>
        <p-button
          label="Run Matching"
          icon="pi pi-sync"
          severity="info"
          (onClick)="onRunMatching()"
          [loading]="isRunningMatcher"
          [disabled]="isLoading"
        >
        </p-button>
      </div>
    </div>

    <!-- Pet Cards Section -->
    <div class="col-12 lg:col-8">
      <p-card styleClass="h-full">
        <ng-template pTemplate="header">
          <div class="flex justify-content-between align-items-center p-4 pb-0">
            <span class="font-semibold text-lg">Current Pets</span>
            <p-button
              label="See full list"
              icon="pi pi-list"
              severity="secondary"
              size="small"
              [text]="true"
              (onClick)="onSeeFullList()"
            >
            </p-button>
          </div>
        </ng-template>

        <div *ngIf="isLoading" class="flex justify-content-center">
          <i class="pi pi-spinner pi-spin text-2xl"></i>
        </div>

        <div
          *ngIf="!isLoading && pets.length === 0"
          class="text-center text-600 py-4"
        >
          <i class="pi pi-info-circle text-3xl mb-3 block"></i>
          <p>No pets currently in the shelter.</p>
        </div>

        <div *ngIf="!isLoading && pets.length > 0" class="grid">
          <div class="col-12 md:col-6 xl:col-4" *ngFor="let pet of pets">
            <p-card styleClass="pet-card h-full">
              <ng-template pTemplate="header">
                <div
                  class="w-full h-10rem -mb-2 border-round-top-xl overflow-hidden"
                >
                  <ng-container
                    *ngIf="
                      petMainImageUrls.get(pet.petId!) as imageUrl;
                      else noImage
                    "
                  >
                    <img
                      [src]="imageUrl"
                      [alt]="pet.name"
                      class="w-full h-full object-cover"
                      (error)="onImageError($event)"
                    />
                  </ng-container>

                  <ng-template #noImage>
                    <div
                      class="w-full h-full bg-gray-100 flex align-items-center justify-content-center"
                    >
                      <i class="pi pi-image text-4xl text-gray-400"></i>
                    </div>
                  </ng-template>
                </div>
              </ng-template>

              <div class="flex flex-column h-full">
                <div class="flex-grow-1">
                  <h3 class="mt-0 mb-2 capitalize">{{ pet.name }}</h3>
                  <div class="flex flex-wrap gap-2 mb-2">
                    <span
                      class="inline-flex align-items-center gap-1 bg-green-50 text-green-600 px-2 py-1 border-round text-xs font-medium"
                    >
                      <i class="pi pi-star"></i>
                      {{ pet.species }}
                    </span>
                    <span
                      class="inline-flex align-items-center gap-1 bg-blue-50 text-blue-600 px-2 py-1 border-round text-xs font-medium capitalize"
                    >
                      <i class="pi pi-heart"></i>
                      {{ pet.breed }}
                    </span>
                    <span
                      class="inline-flex align-items-center gap-1 bg-purple-50 text-purple-600 px-2 py-1 border-round text-xs font-medium"
                    >
                      <i class="pi pi-calendar"></i>
                      {{ pet.age }} {{ pet.age === 1 ? "year" : "years" }}
                    </span>
                    <span
                      class="inline-flex align-items-center gap-1 bg-pink-50 text-pink-600 px-2 py-1 border-round text-xs font-medium"
                    >
                      <i
                        class="pi pi-{{
                          pet.gender?.toLowerCase() === 'male'
                            ? 'mars'
                            : 'venus'
                        }}"
                      ></i>
                      {{ pet.gender }}
                    </span>
                  </div>
                </div>

                <div
                  class="flex justify-content-between align-items-center gap-2"
                >
                  <p-tag
                    [value]="pet.status ?? 'unknown'"
                    [severity]="
                      pet.status ? getStatusSeverity(pet.status) : 'secondary'
                    "
                    class="text-xs capitalize"
                  >
                  </p-tag>
                  <small class="text-600"
                    >Added {{ pet.createdAt | date }}</small
                  >
                </div>
              </div>
            </p-card>
          </div>
        </div>
      </p-card>
    </div>

    <!-- New Applications Section -->
    <div class="col-12 lg:col-4">
      <p-card header="Recent Applications" styleClass="h-full">
        <div *ngIf="isLoading" class="flex justify-content-center">
          <i class="pi pi-spinner pi-spin text-2xl"></i>
        </div>

        <div
          *ngIf="!isLoading && recentApplications.length === 0"
          class="text-center text-600 py-4"
        >
          <i class="pi pi-inbox text-3xl mb-3 block"></i>
          <p>No recent applications.</p>
        </div>

        <div
          *ngIf="!isLoading && recentApplications.length > 0"
          class="flex flex-column gap-3"
        >
          <div
            *ngFor="let application of recentApplications"
            class="border-1 border-gray-200 border-round p-3 application-item"
          >
            <div class="flex justify-content-between align-items-start mb-2">
              <div class="flex-grow-1">
                <h4 class="mt-0 mb-1">{{ application.petName }}</h4>
                <p class="text-600 text-sm mb-1">
                  {{ application.applicantName }}
                </p>
                <p class="text-600 text-xs mb-0">
                  {{ application.applicantEmail }}
                </p>
              </div>
              <p-tag
                [value]="application.status"
                [severity]="getApplicationStatusSeverity(application.status)"
                class="text-xs capitalize"
              >
              </p-tag>
            </div>

            <div class="flex justify-content-between align-items-center">
              <small class="text-600">{{
                formatDate(application.submittedDate)
              }}</small>
              <div
                *ngIf="application.matchScore"
                class="flex align-items-center gap-1"
              >
                <i class="pi pi-star-fill text-yellow-500 text-xs"></i>
                <span class="text-sm font-semibold"
                  >{{ application.matchScore }}%</span
                >
              </div>
            </div>
          </div>
        </div>
      </p-card>
    </div>
  </div>
</div>
